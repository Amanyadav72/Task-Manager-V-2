{% extends 'base.html' %}
{% block content %}
  <div class="dashboard">
    <div class="dashboard-header">
      <h2>Welcome back, {{ current_user.username }}! üëã</h2>
      <a href="{{ url_for('tasks.add_task') }}" class="add-btn">Add New Task</a>
    </div>
    
    <!-- Task Statistics -->
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-number">{{ tasks|length }}</div>
        <div class="stat-label">Total Tasks</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ tasks|selectattr('completed')|list|length }}</div>
        <div class="stat-label">Completed</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ tasks|rejectattr('completed')|list|length }}</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">
          {% if tasks|length > 0 %}
            {{ ((tasks|selectattr('completed')|list|length / tasks|length) * 100)|round|int }}%
          {% else %}
            0%
          {% endif %}
        </div>
        <div class="stat-label">Progress</div>
      </div>
    </div>

    <!-- Task List -->
    {% if tasks %}
      <ul class="task-list">
        {% for task in tasks %}
          <li data-id="{{ task.id }}" data-title="{{ task.title|e }}" 
              class="{% if task.completed %}done{% endif %} 
                     {% if task.priority %}priority-{{ task.priority }}{% endif %}
                     {% if task.is_overdue %}overdue{% endif %}">
            
            <div class="task-content">
              <div class="task-text">{{ task.title }}</div>
              
              <div class="task-meta">
                <span class="task-created">
                  üìÖ Created: {{ task.formatted_created_at }}
                </span>
                
                {% if task.due_date %}
                  <span class="task-due {% if task.is_overdue and not task.completed %}overdue-text{% endif %}">
                    ‚è∞ Due: {{ task.formatted_due_date }}
                    {% if task.is_overdue and not task.completed %}
                      <span class="overdue-badge">OVERDUE</span>
                    {% endif %}
                  </span>
                {% endif %}
                
                <span class="task-priority priority-{{ task.priority }}">
                  {% if task.priority == 'high' %}üî¥ High Priority
                  {% elif task.priority == 'medium' %}üü° Medium Priority  
                  {% else %}üü¢ Low Priority
                  {% endif %}
                </span>
              </div>
            </div>
            
            <div class="task-status"></div>
            <div class="task-actions">
              <button class="task-btn edit" data-task-id="{{ task.id }}">Edit</button>
              <button class="task-btn delete" data-task-id="{{ task.id }}">Delete</button>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">üìù</div>
        <h3>No tasks yet</h3>
        <p>Create your first task to get started!</p>
      </div>
    {% endif %}
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const taskList = document.querySelector('.task-list');
      
      if (taskList) {
        taskList.addEventListener('click', (e) => {
          const taskItem = e.target.closest('li[data-id]');
          if (!taskItem) return;
          
          const taskId = taskItem.dataset.id;
          const taskTitle = taskItem.dataset.title;
          
          if (e.target.classList.contains('edit')) {
            editTask(taskId, taskTitle);
          } else if (e.target.classList.contains('delete')) {
            deleteTask(taskId);
          } else if (!e.target.classList.contains('task-btn') && !e.target.closest('.task-meta')) {
            toggleTask(taskItem, taskId);
          }
        });
      }
    });

    function toggleTask(taskItem, taskId) {
      taskItem.classList.toggle('done');
      
      taskItem.style.transform = 'scale(0.98)';
      setTimeout(() => {
        taskItem.style.transform = '';
      }, 150);
      
      // Simple form submission for now - can be upgraded to AJAX later
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/toggle/${taskId}`;
      document.body.appendChild(form);
      form.submit();
    }

    function editTask(id, title) {
      const newTitle = prompt('Edit task:', title);
      if (newTitle && newTitle.trim() && newTitle !== title) {
        // Simple redirect for now - can be upgraded to AJAX later
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/edit/${id}`;
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'title';
        input.value = newTitle.trim();
        
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
      }
    }

    function deleteTask(id) {
      if (confirm('Are you sure you want to delete this task?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete/${id}`;
        document.body.appendChild(form);
        form.submit();
      }
    }
  </script>
{% endblock %}